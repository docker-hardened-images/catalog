# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/kubeflow-pipelines-apiserver/debian/2.yaml'

name: Kubeflow Pipelines API Server 2.x
image: dhi/kubeflow-pipelines-apiserver
variant: runtime
tags:
    - "2"
    - "2.15"
    - 2.15.0
    - 2-debian13
    - 2.15-debian13
    - 2.15.0-debian13
platforms:
    - linux/amd64
    - linux/arm64
vars:
    ARCH: '#{ target.arch == "amd64" ? "amd64" : "arm64" }'
    ARGO_VERSION: 3.6.7
    BASE_DIGEST: sha256:03672baa78d7e527dd6f46fea2f8bbaaf1799c3ee0d13ce2c14e75b1b3beea6e
    BASE_TAG: 20250419-glibc-debian13
    COMMIT_SHA: 8fe8d7bdd88f027bde080f619762a0b3294796db
    EXPAT_DIGEST: sha256:bf522255414eb53b8992e36dc64fde670d477c0b3be62c84209c4409de35e324
    EXPAT_VERSION: 2.7.3
    GO_DIGEST: sha256:3e717c75bdd2e547755fc90963578c5424b77243f4c35f97ac025ca783a41b6a
    GO_VERSION: 1.24.11
    PYTHON_DIGEST: sha256:bf93eb2ee824691018b063c7bfd0899f717718ad03862c68b040681253888e6a
    PYTHON_VERSION: 3.9.23
    SEMVER_MAJOR_MINOR_VERSION: "2.15"
    SEMVER_MAJOR_VERSION: "2"
    SEMVER_VERSION: 2.15.0
    VERSION: 2.15.0
contents:
    packages:
        - '!base-files'
    builds:
        - name: kubeflow-pipelines-apiserver
          uses: dhi/golang:1.24.11-debian13-dev@sha256:3e717c75bdd2e547755fc90963578c5424b77243f4c35f97ac025ca783a41b6a
          environment:
            GIT_BRANCH: 8fe8d7bdd88f027bde080f619762a0b3294796db
          contents:
            packages:
                - gcc
            files:
                - url: git+https://github.com/kubeflow/pipelines.git#2.15.0
                  checksum: 8fe8d7bdd88f027bde080f619762a0b3294796db
                  path: /go/src/github.com/kubeflow/pipelines
                  spdx:
                    name: kubeflow-pipelines
                    version: 2.15.0
                    packages:
                        - name: kubeflow-pipelines
                          purl: pkg:golang/github.com/kubeflow/pipelines@2.15.0
                          license: Apache-2.0
                  uid: 0
                  gid: 0
          pipeline:
            - name: bump go dependencies
              uses: go/bump@v1
              privileged: true
              with:
                deps:
                    - github.com/go-viper/mapstructure/v2@v2.4.0
                    - golang.org/x/crypto@v0.45.0
                    - github.com/argoproj/argo-workflows/v3@v3.7.5
                dir: /go/src/github.com/kubeflow/pipelines
                download: true
            - name: test
              work-dir: /go/src/github.com/kubeflow/pipelines
              privileged: true
              runs: |
                set -eux -o pipefail

                # TODO Remove these skips once upstream bumps argoproj/argo-workflows/v3 and the tests pass again.
                # Skip tests that are broken by bumping argoproj/argo-workflows/v3 from 3.7.3 to 3.7.5.
                # The new version starting including "creationTimestamp" in return values, which the tests don't expect. There are no actual errors.
                CGO_ENABLED=1 go test -C /go/src/github.com/kubeflow/pipelines \
                  -skip='TestDeletePipelineVersion|TestUploadPipeline_Tarball|TestUploadPipeline_SpecifyFileName|TestUploadPipeline_SpecifyFileDescription|TestCreateRunV1Patch|TestToStringForStore|TestToStringForSchedule' \
                  ./backend/src/.../
            - name: build and install
              work-dir: /go/src/github.com/kubeflow/pipelines
              runs: |
                set -eux -o pipefail

                # NOTE: CGO_ENABLED=1 is required for sqlite3: https://github.com/mattn/go-sqlite3/issues/384#issuecomment-281853073
                CGO_ENABLED=1 go build -C /go/src/github.com/kubeflow/pipelines \
                  -o '${target.dir}/usr/local/bin/apiserver' backend/src/apiserver/*.go

                # https://github.com/kubeflow/pipelines/blob/de3feb58607c6317938e5c5709a24848e30ff0d2/backend/Dockerfile#L76-L78
                sed -E -e 's#/(blob|tree)/master/#/\1/8fe8d7bdd88f027bde080f619762a0b3294796db/#g' -e 's/%252Fmaster/%252F8fe8d7bdd88f027bde080f619762a0b3294796db/#g' -i backend/src/apiserver/config/*.json

                install -d '${target.dir}/config'
                install -m 0644 -t '${target.dir}/config' backend/src/apiserver/config/*.json
          outputs:
            - source: ${target.dir}/usr/local/bin
              target: /usr/local/bin
              uid: 0
              gid: 0
            - source: ${target.dir}/config
              target: /config
              uid: 0
              gid: 0
            - source: /opt/docker/sbom/kubeflow-pipelines
              target: /opt/docker/sbom/kubeflow-pipelines
              uid: 0
              gid: 0
        - name: samples
          uses: dhi/python:3.9.23-debian13-dev@sha256:bf93eb2ee824691018b063c7bfd0899f717718ad03862c68b040681253888e6a
          contents:
            packages:
                - jq
            files:
                - url: git+https://github.com/kubeflow/pipelines.git#2.15.0
                  checksum: 8fe8d7bdd88f027bde080f619762a0b3294796db
                  path: /go/src/github.com/kubeflow/pipelines
                  spdx:
                    name: kubeflow-pipelines
                    version: 2.15.0
                    packages:
                        - name: kubeflow-pipelines
                          purl: pkg:golang/github.com/kubeflow/pipelines@2.15.0
                          license: Apache-2.0
                  uid: 0
                  gid: 0
                - url: https://github.com/argoproj/argo-workflows/releases/download/v3.6.7/argo-linux-${ARCH}.gz
                  checksum: https://github.com/argoproj/argo-workflows/releases/download/v3.6.7/argo-workflows-cli-checksums.txt
                  path: /usr/local/bin/argo
                  uid: 0
                  gid: 0
                  mode: "0755"
          pipeline:
            - name: install python dependencies
              work-dir: /go/src/github.com/kubeflow/pipelines
              privileged: true
              runs: |
                set -eux -o pipefail

                python3 -m venv .venv
                .venv/bin/python3 -m pip install -r backend/requirements.txt
            - name: build and install samples
              work-dir: /go/src/github.com/kubeflow/pipelines
              runs: |
                set -eux -o pipefail

                # https://github.com/kubeflow/pipelines/blob/de3feb58607c6317938e5c5709a24848e30ff0d2/backend/Dockerfile#L50-L54
                jq -r '.pipelines[].file' < backend/src/apiserver/config/sample_config.json | while read -r pipeline_yaml; do
                  pipeline_py=".${pipeline_yaml%.yaml}"
                  .venv/bin/python3 "$pipeline_py"
                  install -D -m 0644 ".${pipeline_yaml}" "${target.dir}${pipeline_yaml}"
                done
          outputs:
            - source: ${target.dir}/samples
              target: /samples
              uid: 0
              gid: 0
    artifacts:
        - name: dhi/static:20250419-glibc-debian13@sha256:03672baa78d7e527dd6f46fea2f8bbaaf1799c3ee0d13ce2c14e75b1b3beea6e
          includes:
            - bin
            - etc
            - home
            - lib
            - lib64
            - opt
            - sbin
            - tmp
            - usr
            - var
          excludes:
            - etc/group
            - etc/os-release
            - etc/passwd
            - var/lib/dpkg/status
          uid: 0
          gid: 0
accounts:
    run-as: nonroot
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
environment:
    COMMIT_SHA: 8fe8d7bdd88f027bde080f619762a0b3294796db
    TAG_NAME: 2.15.0
paths:
    - type: symlink
      path: /usr/bin/apiserver
      uid: 0
      gid: 0
      source: /usr/local/bin/apiserver
annotations:
    org.opencontainers.image.description: API server for Kubeflow Pipelines, providing workflow management and orchestration.
    org.opencontainers.image.licenses: Apache-2.0
entrypoint:
    - /usr/local/bin/apiserver
cmd:
    - --config=/config
    - -logtostderr=true
    - --logLevel=info
    - --sampleconfig=/config/sample_config.json
ports:
    - 8888/tcp
tests:
    - name: Run testcontainers tests
      directory: image/kubeflow-pipelines-apiserver/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
