# syntax=dhi.io/build:2-debian13

name: Azure Functions 4.x for Node 22.x (node22.22)
image: dhi.io/azure-functions-node
variant: runtime
flavor: node22.22
tags:
  - 4-node22.22
  - 4.1046-node22.22
  - 4-debian13-node22.22
  - 4.1046.100-node22.22
  - 4.1046-debian13-node22.22
  - 4.1046.100-debian13-node22.22
platforms:
  - linux/amd64
vars:
  BUILD_NUMBER: "100"
  COMMIT_SHA: c9b95f32abaeb2f441c42464c43ce959e6afc9d8
  DOTNET_REFERENCE: dhi/dotnet:8.0.417-sdk-debian13@sha256:3ceb0d48a944dc2acd4861f37a9a272f886ee46ebfd27d86020ed986d2f57bed
  DOTNET_VERSION: 8.0.417
  EXT_BUNDLE_COMMIT_SHA: 3d5750b4307aa5e29111721f8308bff40f4f5c09
  EXT_BUNDLE_VERSION: 4.31.0
  FUNCTIONS_WORKER: node
  NODE_MAJOR_MINOR_VERSION: "22.22"
  NODE_MAJOR_VERSION: "22"
  NODE_REFERENCE: dhi/node:22.22.0-debian13@sha256:233313cdd094c7b9ddcf396735ec0cb91c27860a2b823fc04028ce4c4a110ac8
  NODE_VERSION: 22.22.0
  SEMVER_MAJOR_MINOR_VERSION: "4.1046"
  SEMVER_MAJOR_VERSION: "4"
  SEMVER_VERSION: 4.1046.100
  TEMPLATES_BUILDID: "257220"
  TEMPLATES_DOWNLOADURL: https://artprodwus21.artifacts.visualstudio.com/Ad1c51fbc-4477-4a0f-b99f-fc9013009a58/ae7e3bf3-d41a-4480-9ac0-b6cf9df9ac24/_apis/artifact/cGlwZWxpbmVhcnRpZmFjdDovL2F6ZnVuYy9wcm9qZWN0SWQvYWU3ZTNiZjMtZDQxYS00NDgwLTlhYzAtYjZjZjlkZjlhYzI0L2J1aWxkSWQvMjU3MjIwL2FydGlmYWN0TmFtZS9kcm9w0/content?format=zip
  VERSION: 4.1046.100
contents:
  repositories:
    - deb [signed-by=/usr/share/keyrings/microsoft-signing-key] https://packages.microsoft.com/debian/13/prod trixie main
  keyring:
    - https://packages.microsoft.com/keys/microsoft-2025.asc
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - libglib2.0-0t64
    - libicu76
    - libsm6
    - libxext6
    - libxrender-dev
    - msodbcsql18
    - mssql-tools18
    - unixodbc
  builds:
    - name: azure-functions-host
      uses: dhi.io/dotnet:8.0.417-sdk-debian13@sha256:3ceb0d48a944dc2acd4861f37a9a272f886ee46ebfd27d86020ed986d2f57bed
      contents:
        packages:
          - bash
          - findutils
        files:
          - url: git+https://github.com/Azure/azure-functions-host.git#v4.1046.100
            checksum: c9b95f32abaeb2f441c42464c43ce959e6afc9d8
            path: ${source.dir}/azure-functions-host
            spdx:
              name: azure-functions-host
              version: 4.1046.100
              packages:
                - name: azure-functions-host
                  purl: pkg:github/Azure/azure-functions-host@4.1046.100
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: build
          work-dir: ${source.dir}/azure-functions-host
          privileged: true
          runs: |
            set -eux -o pipefail

            dotnet publish -v q \
              /p:BuildNumber='100' /p:CommitHash='c9b95f32abaeb2f441c42464c43ce959e6afc9d8' \
              src/WebJobs.Script.WebHost/WebJobs.Script.WebHost.csproj \
              -c Release \
              --output '${target.dir}/azure-functions-host' \
              --runtime linux-x64 --self-contained
        - name: install
          runs: |
            set -eux -o pipefail

            find '${target.dir}/azure-functions-host/workers' -type d -mindepth 1 -maxdepth 1 -not -name 'node' -exec rm -rf '{}' \;
      outputs:
        - source: ${target.dir}/azure-functions-host
          target: /azure-functions-host
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/azure-functions-host
          target: /opt/docker/sbom/azure-functions-host
          uid: 0
          gid: 0
    - name: azure-functions-extension-bundles
      uses: dhi.io/dotnet:8.0.417-sdk-debian13@sha256:3ceb0d48a944dc2acd4861f37a9a272f886ee46ebfd27d86020ed986d2f57bed
      contents:
        packages:
          - bash
          - ca-certificates
          - sed
          - unzip
        files:
          - url: git+https://github.com/Azure/azure-functions-extension-bundles.git#4.31.0
            checksum: 3d5750b4307aa5e29111721f8308bff40f4f5c09
            path: ${source.dir}/azure-functions-extension-bundles
            spdx:
              name: azure-functions-extension-bundles
              version: 4.31.0
              packages:
                - name: azure-functions-extension-bundles
                  purl: pkg:github/Azure/azure-functions-extension-bundles@4.31.0
                  license: MIT
            uid: 0
            gid: 0
          - url: https://artprodwus21.artifacts.visualstudio.com/Ad1c51fbc-4477-4a0f-b99f-fc9013009a58/ae7e3bf3-d41a-4480-9ac0-b6cf9df9ac24/_apis/artifact/cGlwZWxpbmVhcnRpZmFjdDovL2F6ZnVuYy9wcm9qZWN0SWQvYWU3ZTNiZjMtZDQxYS00NDgwLTlhYzAtYjZjZjlkZjlhYzI0L2J1aWxkSWQvMjU3MjIwL2FydGlmYWN0TmFtZS9kcm9w0/content?format=zip
            path: ${source.dir}/templatesArtifacts.zip
            uid: 0
            gid: 0
      pipeline:
        - name: extract templates
          work-dir: ${source.dir}/azure-functions-extension-bundles
          runs: |
            set -eux -o pipefail

            unzip ${source.dir}/templatesArtifacts.zip
            mv drop templatesArtifacts
        - name: patch source
          uses: patch@v1
          with:
            dir: ${source.dir}/azure-functions-extension-bundles
            options: -p1
            patches:
              - ${source.dir}/patch/linux_bundles.patch
        - name: build
          work-dir: ${source.dir}/azure-functions-extension-bundles/build
          privileged: true
          runs: |
            set -eux -o pipefail

            sed -E -i '${source.dir}/azure-functions-extension-bundles/src/Microsoft.Azure.Functions.ExtensionBundle/NuGet.Config' \
              -e 's|azure-functions-extension-bundles|nuget.org|' \
              -e 's|https://pkgs.dev.azure.com/[^"]+|https://api.nuget.org/v3/index.json|'

            TEMPLATES_ARTIFACTS_DIRECTORY=1 dotnet run \
              skip:GenerateVulnerabilityReport,PackageNetCoreV3BundlesWindows,CreateRUPackage,CreateCDNStoragePackage,CreateCDNStoragePackageWindows,BuildBundleBinariesForWindows
        - name: install
          work-dir: ${source.dir}/azure-functions-extension-bundles/artifacts
          runs: |
            set -eux -o pipefail

            mkdir -p ${target.dir}/FuncExtensionBundles/Microsoft.Azure.Functions.ExtensionBundle/4.31.0
            unzip Microsoft.Azure.Functions.ExtensionBundle.4.31.0_linux-x64.zip \
              -d ${target.dir}/FuncExtensionBundles/Microsoft.Azure.Functions.ExtensionBundle/4.31.0
      paths:
        - type: directory
          path: ${source.dir}/patch
          uid: 0
          gid: 0
          source: ecosystem/azure-functions/patch
      outputs:
        - source: ${target.dir}/FuncExtensionBundles
          target: /FuncExtensionBundles
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/azure-functions-extension-bundles
          target: /opt/docker/sbom/azure-functions-extension-bundles
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/node:22.22.0-debian13@sha256:233313cdd094c7b9ddcf396735ec0cb91c27860a2b823fc04028ce4c4a110ac8
      includes:
        - opt/**
        - usr/**
        - var/**
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  ASPNETCORE_CONTENTROOT: /azure-functions-host
  ASPNETCORE_URLS: http://+:80
  AzureFunctionsJobHost__Logging__Console__IsEnabled: "true"
  AzureWebJobsScriptRoot: /home/site/wwwroot
  DOTNET_RUNNING_IN_CONTAINER: "true"
  DOTNET_USE_POLLING_FILE_WATCHER: "true"
  FUNCTIONS_WORKER_RUNTIME: node
  FUNCTIONS_WORKER_RUNTIME_VERSION: 22.22.0
annotations:
  org.opencontainers.image.description: A minimal Azure Functions Node image
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /azure-functions-host/Microsoft.Azure.WebJobs.Script.WebHost
