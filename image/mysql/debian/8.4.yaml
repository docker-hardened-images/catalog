# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/mysql/debian/8.4.yaml'

name: MySQL 8.4.x
image: dhi/mysql
variant: runtime
tags:
    - "8.4"
    - lts
    - 8.4.7
    - 8.4-debian13
    - lts-debian13
    - 8.4.7-debian13
platforms:
    - linux/amd64
    - linux/arm64
dates:
    release: "2024-04-10"
    end-of-life: "2032-04-30"
vars:
    ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
    DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "8.4"
    DEBIAN_EPOCH_MAJOR_VERSION: "8"
    DEBIAN_EPOCH_VERSION: 8.4.7
    VERSION: 8.4.7
contents:
    packages:
        - '!libelogind0'
        - '!mawk'
        - '!original-awk'
        - base-files
        - bash
        - coreutils
        - findutils
        - libaio1t64
        - libncurses6
        - libnuma1
        - libstdc++6
    builds:
        - name: mysql
          contents:
            packages:
                - bash
                - coreutils
                - gpg
                - gpg-agent
                - gzip
                - tar
                - xz-utils
            files:
                - url: https://cdn.mysql.com/Downloads/MySQL-8.4/mysql-8.4.7-linux-glibc2.28-${ARCH}.tar.xz.asc
                  path: ${source.dir}/sigs/mysql.tar.xz.asc
                  uid: 0
                  gid: 0
                - url: https://cdn.mysql.com/Downloads/MySQL-8.4/mysql-8.4.7-linux-glibc2.28-${ARCH}.tar.xz
                  path: ${source.dir}/mysql.tar.xz
                  spdx:
                    name: mysql
                    version: 8.4.7
                    packages:
                        - name: mysql
                          purl: pkg:dhi/mysql@8.4.7
                          license: GPL-2.0-only
                  uid: 0
                  gid: 0
          pipeline:
            - name: install
              runs: |
                set -eux -o pipefail

                GNUPGHOME="$(mktemp -d)"
                export GNUPGHOME

                gpg --import "${source.dir}/key/mysql-key.asc"
                gpg --batch --verify "${source.dir}/sigs/mysql.tar.xz.asc" mysql.tar.xz

                mkdir -p "${target.dir}/opt/mysql-8.4.7"
                tar -xvf mysql.tar.xz -C "${target.dir}/opt/mysql-8.4.7" --strip-components=1

                if [ "${target.fips}" = "true" ]; then
                  rm "${target.dir}/opt/mysql-8.4.7"/lib/private/libssl*
                  rm "${target.dir}/opt/mysql-8.4.7"/lib/private/libcrypto*
                fi
          paths:
            - type: file
              path: ${source.dir}/key/mysql-key.asc
              uid: 0
              gid: 0
              source: image/mysql/key/mysql-key.asc
          outputs:
            - source: ${target.dir}/opt/mysql-8.4.7
              target: /opt/mysql-8.4.7
              uid: 65532
              gid: 65532
            - source: /opt/docker/sbom/mysql
              target: /opt/docker/sbom/mysql
              uid: 0
              gid: 0
accounts:
    run-as: mysql
    users:
        - name: mysql
          uid: 65532
          gid: 65532
    groups:
        - name: mysql
          gid: 65532
          members:
            - mysql
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
environment:
    MYSQLDATA: /var/lib/mysql
    PATH: /opt/mysql-8.4.7/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
    - type: directory
      path: /tmp
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: directory
      path: /var/lib/mysql-files
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: directory
      path: /var/lib/mysql
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: directory
      path: /var/run/mysqld
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: directory
      path: /var/lib/data/
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: file
      path: /usr/local/bin/docker-entrypoint.sh
      uid: 0
      gid: 0
      mode: "0755"
      source: image/mysql/bin/docker-entrypoint.sh
    - type: symlink
      path: /usr/lib/${ARCH}-linux-gnu/libaio.so.1
      uid: 0
      gid: 0
      source: libaio.so.1t64
annotations:
    org.opencontainers.image.description: A minimal MySQL image
    org.opencontainers.image.licenses: GPL-2.0-only
entrypoint:
    - /usr/local/bin/docker-entrypoint.sh
cmd:
    - mysqld
ports:
    - 3306/tcp
    - 33060/tcp
tests:
    - name: Run testcontainers tests
      directory: image/mysql/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
