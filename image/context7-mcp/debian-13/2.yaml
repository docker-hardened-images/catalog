# syntax=dhi.io/build:2-debian13

name: Upstash Context7 MCP 2.x
image: dhi.io/context7-mcp
variant: runtime
tags:
  - "2"
  - "2.1"
  - 2.1.2
  - latest
  - 2-debian13
  - 2.1-debian13
  - 2.1.2-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  ARCH: '#{ target.arch == "amd64" ? "x64" : "arm64" }'
  COMMIT_SHA: 76d70a12230bf23f5ffb3f35288ec6c25fa41874
  NODE_BUILD_REFERENCE: dhi/node:24.14.0-debian13-sfw-dev@sha256:db6e203becd2cb9f9cd35cc02444a2bea652b66e545a4ad3588e693d26dcd6d9
  NODE_RUNTIME_REFERENCE: dhi/node:24.14.0-debian13@sha256:ff4f2e2296608e840e8822815d4407c6bae872fb85c664375a189dc70249f1ce
  PNPM_VERSION: 10.30.3
  SEMVER_MAJOR_MINOR_VERSION: "2.1"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.1.2
  VERSION: 2.1.2
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
  builds:
    - name: context7-mcp
      uses: dhi.io/node:24.14.0-debian13-sfw-dev@sha256:db6e203becd2cb9f9cd35cc02444a2bea652b66e545a4ad3588e693d26dcd6d9
      contents:
        files:
          - url: https://github.com/pnpm/pnpm/releases/download/v10.30.3/pnpm-linux-${ARCH}
            path: /usr/local/bin/pnpm
            uid: 0
            gid: 0
            mode: "0755"
          - url: git+https://github.com/upstash/context7.git#@upstash/context7-mcp@2.1.2
            checksum: 76d70a12230bf23f5ffb3f35288ec6c25fa41874
            path: ${source.dir}/context7-76d70a12230bf23f5ffb3f35288ec6c25fa41874
            spdx:
              name: context7-mcp
              version: 2.1.2
              packages:
                - name: context7-mcp
                  purl: pkg:dhi/context7-mcp@2.1.2
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: update dependencies
          work-dir: ${source.dir}/context7-76d70a12230bf23f5ffb3f35288ec6c25fa41874
          privileged: true
          runs: |
            set -eux -o pipefail

            npm pkg set pnpm.overrides."@modelcontextprotocol/sdk"=1.25.2 # CVE-2026-25536 (1.26.0 breaks MCP server)
            npm pkg set pnpm.overrides.hono=4.11.10                       # CVE-2026-24398, CVE-2026-24472, CVE-2026-24473, CVE-2026-24771, GHSA-gq3j-xvxp-8hrf
            npm pkg set pnpm.overrides.minimatch=10.2.3                   # CVE-2026-26996, CVE-2026-27903, CVE-2026-27904
            npm pkg set pnpm.overrides.qs=6.14.2                          # CVE-2025-15284, CVE-2026-2391
            npm pkg set pnpm.overrides."body-parser"=2.2.1                # CVE-2025-13466
            npm pkg set pnpm.overrides.undici=6.23.0                      # CVE-2026-22036
            sfw pnpm update
        - name: update dependencies
          work-dir: ${source.dir}/context7-76d70a12230bf23f5ffb3f35288ec6c25fa41874/packages/mcp
          privileged: true
          runs: |
            set -eux -o pipefail

            npm pkg set pnpm.overrides.hono=4.11.10        # CVE-2026-24398, CVE-2026-24472, CVE-2026-24473, CVE-2026-24771, GHSA-gq3j-xvxp-8hrf
            npm pkg set pnpm.overrides.minimatch=10.2.3    # CVE-2026-26996, CVE-2026-27903, CVE-2026-27904
            npm pkg set pnpm.overrides.qs=6.14.2           # CVE-2025-15284, CVE-2026-2391
            npm pkg set pnpm.overrides."body-parser"=2.2.1 # CVE-2025-13466
            npm pkg set pnpm.overrides.undici=6.23.0       # CVE-2026-22036
            sfw pnpm add hono@4.11.10 --filter @upstash/context7-mcp --save-exact
            sfw pnpm update
        - name: build
          work-dir: ${source.dir}/context7-76d70a12230bf23f5ffb3f35288ec6c25fa41874
          privileged: true
          runs: |
            set -eux -o pipefail

            sfw pnpm install --frozen-lockfile
            sfw pnpm --filter @upstash/context7-mcp build
        - name: setup
          work-dir: ${source.dir}/context7-76d70a12230bf23f5ffb3f35288ec6c25fa41874
          privileged: true
          environment:
            CI: "true"
          runs: |
            set -eux -o pipefail

            sfw pnpm install --frozen-lockfile --prod --filter @upstash/context7-mcp

            # remove all esbuild dependencies
            rm -rf node_modules/.pnpm/*esbuild*
      outputs:
        - source: ${source.dir}/context7-76d70a12230bf23f5ffb3f35288ec6c25fa41874/packages/mcp
          target: /app/packages/mcp
          uid: 0
          gid: 0
        - source: ${source.dir}/context7-76d70a12230bf23f5ffb3f35288ec6c25fa41874/node_modules
          target: /app/node_modules
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/context7-mcp
          target: /opt/docker/sbom/context7-mcp
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/node:24.14.0-debian13@sha256:ff4f2e2296608e840e8822815d4407c6bae872fb85c664375a189dc70249f1ce
      uid: 0
      gid: 0
accounts:
  run-as: node
  users:
    - name: node
      uid: 1000
      gid: 1000
  groups:
    - name: node
      gid: 1000
      members:
        - node
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /app/packages/mcp
annotations:
  org.opencontainers.image.description: Upstash Context7 MCP Server
  org.opencontainers.image.licenses: MIT
labels:
  io.modelcontextprotocol.server.name: io.upstash/context7-mcp
cmd:
  - node
  - dist/index.js
  - --transport
  - http
  - --port
  - "8080"
ports:
  - 8080/tcp
