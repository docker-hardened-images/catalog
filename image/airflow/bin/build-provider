#!/usr/bin/bash

# Call with the provider name as an arguments in the airflow project directory.
# Example: cd /src/airflow && /src/scripts/build-provider provider-name

set -eux -o pipefail

if [[ $# -ne 1 ]]; then
    echo "Usage: $0 <provider-name>" >&2
    echo "Error: Expected exactly 1 argument, got $#" >&2
    exit 1
fi

provider=$1
provider_package_name=apache-airflow-providers-${provider}

# We need to checkout the correct tag for the provider based on the constraints file
# First, look up the full line and extract version with parameter expansion
line=$(grep "^${provider_package_name}==" constraints.txt)
version="${line##*==}"
if [[ -z "$version" ]]; then
    echo "Package $provider_package_name not found in constraints.txt" >&2
    exit 1
fi

# Construct the tag and checkout
tag="providers-${provider}/${version}"
git checkout "$tag"

uv build --package "$provider_package_name"
