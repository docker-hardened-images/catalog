# syntax=dhi.io/build:2-debian13

name: drbd9 9.x
image: dhi.io/drbd9
variant: runtime
tags:
  - "9"
  - "9.2"
  - 9.2.16
  - 9-debian13
  - 9.2-debian13
  - 9.2.16-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2015-06-16"
vars:
  BASE_DIGEST: sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
  BASE_TAG: 20250419-debian13
  BINUTILS_DIGEST: sha256:f63e465d4a2f59ba5af48164c16fbd05fbe141e4b932ff27a0bec5e45edf6199
  BINUTILS_VERSION: "2.45"
  DRBD_COMMIT_SHA: 3a0f974085c481737e13fb39f03ccd85b63eb7df
  DRBD_HEADERS_CHECKSUM: 23580dedcc07c66946f56ab122dc27c447e54fc5ed9fdd3776897a551408c159
  DRBD_HEADERS_COMMIT_SHA: d04ab134e919627a73d371fe12ce2d95216d0328
  DRBD_TARBALL_CHECKSUM: b1bd466c7c44d133a547b45d052489cda4fdc7013bc0837c973691e7ba49cfa0
  DRBD_VERSION: 9.2.16
  ENTRY_SH_CHECKSUM: d4eae12e115fc8b83c1d8ba4ccc5baa04429c674abf9a8272012fa7677439f82
  PYTHON_BUILD_REFERENCE: dhi/python:3.14.3-debian13-dev@sha256:e804df61d954e90edc605f29bfc89d22df071bd35709f42cc8d783b718c41b97
  PYTHON_LBDIST_COMMIT_SHA: 1e9160e430017ba476631b8f6ddd6bf234948fed
  PYTHON_REFERENCE: dhi/python:3.14.3-debian13@sha256:4f2b657d70b0d1e30576718a866332d594627a4b4af1a2d16aaf275e298b0d92
  SEMVER_MAJOR_MINOR_VERSION: "9.2"
  SEMVER_MAJOR_VERSION: "9"
  SEMVER_VERSION: 9.2.16
  VERSION: 9.2.16
contents:
  packages:
    - '!base-files'
    - '!binutils'
    - '!binutils-aarch64-linux-gnu'
    - '!binutils-common'
    - '!binutils-x86-64-linux-gnu'
    - '!libbinutils'
    - '!libctf-nobfd0'
    - '!libctf0'
    - '!libelogind0'
    - '!libgprofng0'
    - '!libsframe1'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - coreutils
    - curl
    - diffutils
    - elfutils
    - findutils
    - gcc
    - gcc-13
    - gnu-which
    - gnupg
    - grep
    - gzip
    - kmod
    - libc6-dev
    - make
    - patch
    - perl
    - sed
    - tar
    - util-linux
  files:
    - url: https://raw.githubusercontent.com/LINBIT/drbd/3a0f974085c481737e13fb39f03ccd85b63eb7df/docker/entry.sh
      checksum: sha256:d4eae12e115fc8b83c1d8ba4ccc5baa04429c674abf9a8272012fa7677439f82
      path: /entry.sh
      spdx:
        name: drbd-entry-script
        version: 9.2.16
        packages:
          - name: drbd-entry-script
            purl: pkg:github/LINBIT/drbd@3a0f974085c481737e13fb39f03ccd85b63eb7df#docker/entry.sh
            license: GPL-2.0
      uid: 0
      gid: 0
      mode: "0755"
  builds:
    - name: prepare-drbd-tarball
      uses: dhi.io/static:20250419-debian13@sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
      contents:
        packages:
          - bash
          - coreutils
          - gzip
          - tar
        files:
          - url: https://github.com/LINBIT/drbd/archive/drbd-9.2.16.tar.gz
            checksum: sha256:b1bd466c7c44d133a547b45d052489cda4fdc7013bc0837c973691e7ba49cfa0
            path: ${source.dir}/drbd.tar.gz
            spdx:
              name: drbd
              version: 9.2.16
              packages:
                - name: drbd
                  purl: pkg:github/LINBIT/drbd@drbd-9.2.16
                  license: GPL-2.0
            uid: 0
            gid: 0
          - url: https://github.com/LINBIT/drbd-headers/archive/d04ab134e919627a73d371fe12ce2d95216d0328.tar.gz
            checksum: sha256:23580dedcc07c66946f56ab122dc27c447e54fc5ed9fdd3776897a551408c159
            path: ${source.dir}/drbd-headers.tar.gz
            spdx:
              name: drbd-headers
              version: d04ab134e919627a73d371fe12ce2d95216d0328
              packages:
                - name: drbd-headers
                  purl: pkg:dhi/drbd9@d04ab134e919627a73d371fe12ce2d95216d0328
                  license: GPL-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: assemble drbd source tarball with submodule and git revision
          runs: |
            set -eux -o pipefail

            # Extract the main DRBD tarball
            cd ${target.dir}
            tar xzf ${source.dir}/drbd.tar.gz

            cd drbd-drbd-9.2.16

            # Create the .drbd_git_revision file with the commit SHA
            # (required by DRBD Makefile, not present in GitHub archive tarballs)
            mkdir -p drbd
            echo "GIT-hash: 3a0f974085c481737e13fb39f03ccd85b63eb7df" > drbd/.drbd_git_revision

            # Populate drbd-headers submodule content
            # GitHub archive tarballs don't include git submodule contents.
            # The drbd-headers submodule provides kernel UAPI headers needed by
            # the compat patch system (Kbuild.drbd-module-sources lists these files).
            tar xzf ${source.dir}/drbd-headers.tar.gz -C drbd/drbd-headers --strip-components=1

            # Re-package the tarball with all content
            cd ${target.dir}
            tar czf drbd.tar.gz drbd-drbd-9.2.16
      outputs:
        - source: ${target.dir}/drbd.tar.gz
          target: /drbd.tar.gz
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/drbd
          target: /opt/docker/sbom/drbd
          uid: 0
          gid: 0
    - name: setup
      uses: dhi.io/python:3.14.3-debian13-dev@sha256:e804df61d954e90edc605f29bfc89d22df071bd35709f42cc8d783b718c41b97
      contents:
        packages:
          - bash
          - coreutils
          - tar
        files:
          - url: git+https://github.com/LINBIT/python-lbdist.git#master
            checksum: 1e9160e430017ba476631b8f6ddd6bf234948fed
            path: ${source.dir}/python-lbdist
            spdx:
              name: python-lbdist
              version: master
              packages:
                - name: python-lbdist
                  purl: pkg:github/LINBIT/python-lbdist@1e9160e430017ba476631b8f6ddd6bf234948fed
                  license: GPL-3.0
            uid: 0
            gid: 0
      pipeline:
        - name: install setuptools without vendored wheel
          privileged: true
          runs: |
            set -eux -o pipefail

            # Install setuptools to the build container for python-lbdist installation
            python3 -m pip install --break-system-packages setuptools

            # Install setuptools to target directory for runtime and remove vendored wheel
            python3 -m pip install --break-system-packages --target=${target.dir}/usr/lib/python3/dist-packages setuptools
            find ${target.dir}/usr/lib/python3/dist-packages/setuptools/_vendor -name 'wheel-0.45.*' -type d -exec rm -rf {} + 2> /dev/null || true
            rm -rf ${target.dir}/usr/lib/python3/dist-packages/setuptools/_vendor/wheel
        - name: install python-lbdist
          work-dir: ${source.dir}/python-lbdist
          runs: |
            set -eux -o pipefail

            # Install lbdist module to /opt/lbdist using --target for flat layout
            python3 -m pip install --break-system-packages --no-build-isolation --target=${target.dir}/opt/lbdist .

            # Copy lbdisttool.py script to bin directory on PATH
            # pip --target puts scripts in bin/ subdirectory of target
            mkdir -p ${target.dir}/usr/local/bin
            cp ${target.dir}/opt/lbdist/bin/lbdisttool.py ${target.dir}/usr/local/bin/lbdisttool.py
      outputs:
        - source: ${target.dir}/opt/lbdist
          target: /opt/lbdist
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin
          target: /usr/local/bin
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/lib/python3/dist-packages
          target: /usr/lib/python3/dist-packages
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/python-lbdist
          target: /opt/docker/sbom/python-lbdist
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/pkg-binutils:2.45-debian13@sha256:f63e465d4a2f59ba5af48164c16fbd05fbe141e4b932ff27a0bec5e45edf6199
      excludes:
        - etc/group
        - etc/os-release
        - etc/passwd
        - var/lib/dpkg/status
      uid: 0
      gid: 0
    - name: dhi.io/python:3.14.3-debian13@sha256:4f2b657d70b0d1e30576718a866332d594627a4b4af1a2d16aaf275e298b0d92
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
    - name: dhi.io/static:20250419-debian13@sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
      includes:
        - bin
        - etc
        - home
        - lib
        - lib64
        - opt
        - sbin
        - tmp
        - usr
        - var
      excludes:
        - etc/group
        - etc/os-release
        - etc/passwd
        - var/lib/dpkg/status
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  LB_HOW: compile
  PYTHONPATH: /opt/lbdist
paths:
  - type: directory
    path: /pkgs
    uid: 0
    gid: 0
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal drbd9 image
  org.opencontainers.image.licenses: GPL-2.0
entrypoint:
  - /entry.sh
