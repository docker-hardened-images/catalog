# syntax=dhi.io/build:2-alpine3.23

image: dhi.io/pkg-python
variant: runtime
tags:
  - 3.11.14-apk-alpine3.23
  - 3.11.14-r0-apk-alpine3.23
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COSIGN_DIGEST: sha256:9dfbfe297449aa1f23f4ea8dc1872c91ce40c810b851ae075e0a703461426dc1
  COSIGN_VERSION: 2.5.0
  OIDC_IDENTITY: pablogsal@python.org
  OIDC_ISSUER: https://accounts.google.com
  PACKAGE_NAME: python-3.11
  PATCH_CVE-2025-12084: https://github.com/python/cpython/commit/b95c10349956d95e258553def0fcc52ea3ef8f82.patch
  PATCH_CVE-2025-13836: https://github.com/python/cpython/commit/4f2bc24b750a82d3b439f174e7717fc09820bfeb.patch
  PATCH_CVE-2025-13837: https://github.com/python/cpython/commit/aa9edbb11a2bf7805fd5046cdd5c2d3864aa39f2.patch
  PIP_CHECKSUM: sha256:bdb1b08f4274833d62c1aa29e20907365a2ceb950410df15fc9521bad440122b
  PIP_URL: https://files.pythonhosted.org/packages/de/f0/c81e05b613866b76d2d1066490adf1a3dbc4ee9d9c839961c3fc8a6997af/pip-26.0.1-py3-none-any.whl
  PIP_VERSION: 26.0.1
  PYTHON_MAJOR_MINOR_VERSION: "3.11"
  PYTHON_MAJOR_VERSION: "3"
  PYTHON_VERSION: 3.11.14
  REL: "0"
  SEMVER_MAJOR_MINOR_VERSION: "3.11"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.11.14
  SETUPTOOLS_CHECKSUM: sha256:70b18734b607bd1da571d097d236cfcfacaf01de45717d59e6e04b96877532e0
  SETUPTOOLS_URL: https://files.pythonhosted.org/packages/e1/c6/76dc613121b793286a3f91621d7b75a2b493e0390ddca50f11993eadf192/setuptools-82.0.0-py3-none-any.whl
  SETUPTOOLS_VERSION: ""
  VERSION: 3.11.14
  WHEEL_CHECKSUM: sha256:4b399d56c9d9338230118d705d9737a2a468ccca63d5e813e2a4fc7815d8bc4d
  WHEEL_URL: https://files.pythonhosted.org/packages/87/22/b76d483683216dde3d67cba61fb2444be8d5be289bf628c13fc0fd90e5f9/wheel-0.46.3-py3-none-any.whl
  WHEEL_VERSION: 0.46.3
contents:
  repositories:
    - https://dhi.io/apk/alpine/v3.23/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.23/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.23/community
  keyring:
    - https://dhi.io/keyring/dhi-apk@docker-0F81AD7700D99184.rsa.pub
  packages:
    - alpine-baselayout-data
  builds:
    - name: python
      contents:
        packages:
          - ca-certificates-bundle
          - busybox
          - musl
          - dpkg-dev
          - dpkg
          - bluez-dev
          - bzip2-dev
          - expat-dev
          - gcc
          - gdbm-dev
          - libc-dev
          - libffi-dev
          - libnsl-dev
          - libtirpc-dev
          - linux-headers
          - make
          - mpdecimal-dev
          - ncurses-dev
          - openssl-dev
          - pax-utils
          - readline-dev
          - sqlite-dev
          - tcl-dev
          - tk
          - tk-dev
          - xz-dev
          - zlib-dev
          - git
          - zip
          - cosign-3
          - musl-locales
        files:
          - url: https://github.com/python/cpython/commit/4f2bc24b750a82d3b439f174e7717fc09820bfeb.patch
            path: ${source.dir}/patch/CVE-2025-13836.patch
            uid: 0
            gid: 0
          - url: https://github.com/python/cpython/commit/aa9edbb11a2bf7805fd5046cdd5c2d3864aa39f2.patch
            path: ${source.dir}/patch/CVE-2025-13837.patch
            uid: 0
            gid: 0
          - url: https://github.com/python/cpython/commit/b95c10349956d95e258553def0fcc52ea3ef8f82.patch
            path: ${source.dir}/patch/CVE-2025-12084.patch
            uid: 0
            gid: 0
          - url: https://files.pythonhosted.org/packages/de/f0/c81e05b613866b76d2d1066490adf1a3dbc4ee9d9c839961c3fc8a6997af/pip-26.0.1-py3-none-any.whl
            checksum: sha256:bdb1b08f4274833d62c1aa29e20907365a2ceb950410df15fc9521bad440122b
            path: ${source.dir}/pip-26.0.1-py3-none-any.whl
            uid: 0
            gid: 0
          - url: https://files.pythonhosted.org/packages/87/22/b76d483683216dde3d67cba61fb2444be8d5be289bf628c13fc0fd90e5f9/wheel-0.46.3-py3-none-any.whl
            checksum: sha256:4b399d56c9d9338230118d705d9737a2a468ccca63d5e813e2a4fc7815d8bc4d
            path: ${source.dir}/wheel-0.46.3-py3-none-any.whl
            uid: 0
            gid: 0
          - url: https://www.python.org/ftp/python/3.11.14/Python-3.11.14.tar.xz.sigstore
            path: ${source.dir}/python.tar.xz.sigstore
            uid: 0
            gid: 0
          - url: https://www.python.org/ftp/python/3.11.14/Python-3.11.14.tar.xz
            path: ${source.dir}/python.tar.xz
            spdx:
              name: python
              version: 3.11.14
              packages:
                - name: python
                  purl: pkg:dhi/python@3.11.14
                  license: PSF-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: verify
          uses: cosign/verify-blob@v1
          with:
            blob: ${source.dir}/python.tar.xz
            certificate-identity: pablogsal@python.org
            certificate-oidc-issuer: https://accounts.google.com
            offline: true
            signature: ${source.dir}/python.tar.xz.sigstore
        - name: install
          runs: |
            set -eux -o pipefail

            tar -xaf python.tar.xz --strip-components=1

            if [ -f "${source.dir}/patch/CVE-2025-13836.patch" ]; then
              git apply "${source.dir}/patch/CVE-2025-13836.patch"
            fi
            if [ -f "${source.dir}/patch/CVE-2025-13837.patch" ]; then
              git apply "${source.dir}/patch/CVE-2025-13837.patch"
            fi
            if [ -f "${source.dir}/patch/CVE-2025-12084.patch" ]; then
              git apply "${source.dir}/patch/CVE-2025-12084.patch"
            fi

            gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)"

            if [ -f "${source.dir}/pip-26.0.1-py3-none-any.whl" ]; then
              rm -rf Lib/ensurepip/_bundled/pip*
              cp "${source.dir}/pip-26.0.1-py3-none-any.whl" Lib/ensurepip/_bundled/
              sed -i "s/_PIP_VERSION = \".*\"/_PIP_VERSION = \"26.0.1\"/g" Lib/ensurepip/__init__.py
            fi

            if [ -f "${source.dir}/setuptools--py3-none-any.whl" ]; then
              rm -rf Lib/ensurepip/_bundled/setuptools*
              cp "${source.dir}/setuptools--py3-none-any.whl" Lib/ensurepip/_bundled/
              sed -i "s/_SETUPTOOLS_VERSION = \".*\"/_SETUPTOOLS_VERSION = \"\"/g" Lib/ensurepip/__init__.py
            fi

            if [ -f "${source.dir}/wheel-0.46.3-py3-none-any.whl" ]; then
              rm -rf Lib/ensurepip/_bundled/wheel*
              cp "${source.dir}/wheel-0.46.3-py3-none-any.whl" Lib/ensurepip/_bundled/
              sed -i "s/_WHEEL_VERSION = \".*\"/_WHEEL_VERSION = \"0.46.3\"/g" Lib/ensurepip/__init__.py
            fi

            # Replace vendored wheel in setuptools if present
            if [ -f "${source.dir}/setuptools--py3-none-any.whl" ] && [ -f "${source.dir}/wheel-0.46.3-py3-none-any.whl" ]; then
              # Verify wheel files are valid zip archives before extracting
              if ! python3 -m zipfile -t "${source.dir}/setuptools--py3-none-any.whl" > /dev/null 2>&1; then
                echo "Error: setuptools wheel file is not a valid zip archive"
                exit 1
              fi
              if ! python3 -m zipfile -t "${source.dir}/wheel-0.46.3-py3-none-any.whl" > /dev/null 2>&1; then
                echo "Error: wheel file is not a valid zip archive"
                exit 1
              fi

              # Extract both wheels
              python3 -m zipfile -e "${source.dir}/setuptools--py3-none-any.whl" setuptools_temp/
              python3 -m zipfile -e "${source.dir}/wheel-0.46.3-py3-none-any.whl" wheel_temp/

              # Remove old vendored wheel from setuptools
              rm -rf setuptools_temp/setuptools/_vendor/wheel*

              # Copy new wheel into setuptools vendor directory
              cp -r wheel_temp/wheel/ setuptools_temp/setuptools/_vendor/
              cp -r wheel_temp/wheel-0.46.3.dist-info/ setuptools_temp/setuptools/_vendor/

              # Repackage setuptools with all its contents (including _distutils_hack, etc.)
              (cd setuptools_temp && zip -r "../setuptools--patched.whl" .)

              # Verify _distutils_hack is still present in the repacked wheel if it was in the original
              if python3 -m zipfile -l "${source.dir}/setuptools--py3-none-any.whl" | grep -q "_distutils_hack"; then
                if ! python3 -m zipfile -l "setuptools--patched.whl" | grep -q "_distutils_hack"; then
                  echo "ERROR: _distutils_hack was present in original setuptools but missing from repacked wheel!"
                  python3 -m zipfile -l "setuptools--patched.whl" | head -30
                  exit 1
                fi
              fi

              mv "setuptools--patched.whl" "Lib/ensurepip/_bundled/setuptools--py3-none-any.whl"
              rm -rf setuptools_temp wheel_temp
            fi

            # Verify the bundled setuptools wheel still has _distutils_hack if it should
            if python3 -m zipfile -l "${source.dir}/setuptools--py3-none-any.whl" | grep -q "_distutils_hack"; then
              python3 -m zipfile -l Lib/ensurepip/_bundled/setuptools--py3-none-any.whl | grep "_distutils_hack" || (
                echo "ERROR: _distutils_hack not in bundled setuptools wheel!"
                python3 -m zipfile -l Lib/ensurepip/_bundled/setuptools--py3-none-any.whl | head -30
                exit 1
              )
            fi

            # force system libs
            rm -r Modules/expat

            nproc="$(nproc)"

            # set thread stack size to 2MB so we don't segfault before we hit
            # sys.getrecursionlimit()
            # note: raised from 1 as we ran into some stack limit on x86_64 too
            # sometimes, but not recursion
            stacksize=0x200000

            # we want -O2 here for more speed for such a large interpreter.
            export CFLAGS_NODIST="-O2 -DTHREAD_STACK_SIZE=$stacksize"
            export CXXFLAGS_NODIST="-O2"
            export LDFLAGS_NODIST="-Wl,-z,stack-size=$stacksize"

            unset LDFLAGS CFLAGS CXXFLAGS CPPFLAGS

            ./configure \
              --prefix=/usr \
              --enable-ipv6 \
              --enable-loadable-sqlite-extensions \
              --enable-optimizations \
              --enable-shared \
              --with-lto \
              --with-computed-gotos \
              --with-dbmliborder=gdbm:ndbm \
              --with-system-expat \
              --with-system-libmpdec \
              --without-ensurepip

            # Skip test_re during PGO (musl doesn't support iso88591 locale encoding)
            # Python 3.13's test_re includes locale tests that fail on Alpine/musl
            make -j "$nproc" PROFILE_TASK='-m test --pgo --timeout=1200 -x test_re'

            make DESTDIR="${target.dir}" install maninstall

            install -Dm644 LICENSE "${target.dir}/usr/share/licenses/python-3.11/LICENSE"

            ln -s python3 "${target.dir}/usr/bin/python"
            ln -s python3-config "${target.dir}/usr/bin/python-config"
            ln -s idle3 "${target.dir}/usr/bin/idle"
            ln -s pydoc3 "${target.dir}/usr/bin/pydoc"

            # Verify _distutils_hack was installed if it was present in the wheel
            if python3 -m zipfile -l Lib/ensurepip/_bundled/setuptools--py3-none-any.whl | grep -q "_distutils_hack"; then
              if [ ! -d "${target.dir}/usr/lib/python3.11/site-packages/_distutils_hack" ]; then
                echo "ERROR: _distutils_hack directory not found in installed site-packages!"
                ls -la "${target.dir}/usr/lib/python3.11/site-packages/" | head -20
                exit 1
              fi
              if [ ! -f "${target.dir}/usr/lib/python3.11/site-packages/_distutils_hack/override.py" ]; then
                echo "ERROR: _distutils_hack/override.py file not found!"
                ls -la "${target.dir}/usr/lib/python3.11/site-packages/_distutils_hack/"
                exit 1
              fi
            fi
        - uses: abuild/setup@v1
        - uses: abuild/apk@v1
          work-dir: ${source.dir}/aports/python-3.11
          with:
            description: Python programming language
            functions:
              _default_pyc: |
                replaces="python3-pyc"
                provides="python3-pyc=3.11.14-r0"
                pkgdesc="$pkgdesc (install .pyc cache files)"
                install_if="$pkgname=$pkgver-r$pkgrel"
                depends="
                  $pkgname-pycache-pyc0=$pkgver-r$pkgrel
                  pyc-3.11
                  "
                mkdir -p "$subpkgdir"
              _pyc_meta: |
                replaces="pyc"
                provides="pyc=3.11.14-r0"
                pkgdesc="Meta package for pulling in all -pyc packages"
                depends=""
                mkdir -p "$subpkgdir"
              dev: |
                replaces="python3-dev"
                provides="python3-dev=3.11.14-r0"
                default_dev

                # pyconfig.h is needed runtime so we move it back
                mkdir -p "$pkgdir"/usr/include/python3.11
                mv "$subpkgdir"/usr/include/python3.11/pyconfig.h \
                  "$pkgdir"/usr/include/python3.11/
              gdbm: |
                replaces="python3-gdbm"
                provides="python3-gdbm=3.11.14-r0"
                pkgdesc="Python backend for GNU gdbm"
                amove usr/lib/python3.11*/lib-dynload/_gdbm.cpython*
              pyc0: |
                replaces="python3-pycache-pyc0"
                provides="python3-pycache-pyc0=3.11.14-r0"
                pkgdesc="$pkgdesc (.pyc pycache files)"
                cd "$pkgdir"
                amove $(find usr/lib/python3* -name "*.pyc")
              pyc1: |
                replaces="python3-pycache-pyc1"
                provides="python3-pycache-pyc1=3.11.14-r0"
                pkgdesc="$pkgdesc (.opt-1.pyc pycache files)"
                cd "$pkgdir"
                amove $(find usr/lib/python3* -name "*.opt-1.pyc")
              pyc2: |
                replaces="python3-pycache-pyc2"
                provides="python3-pycache-pyc2=3.11.14-r0"
                pkgdesc="$pkgdesc (.opt-2.pyc pycache files)"
                cd "$pkgdir"
                amove $(find usr/lib/python3* -name "*.opt-2.pyc")
              tests: |
                replaces="python3-tests"
                provides="python3-tests=3.11.14-r0"
                pkgdesc="The test modules from the main python package"
                amove usr/lib/python3.11/test
            license: PSF-2.0
            name: python-3.11
            options: '!check'
            provider_priority: 200
            provides: python3=3.11.14-r0
            rel: 0
            replaces: python3
            subpackages: $pkgname-dbg $pkgname-dev $pkgname-doc $pkgname-tests::noarch $pkgname-pyc:_default_pyc $pkgname-pycache-pyc2 $pkgname-pycache-pyc1 $pkgname-pycache-pyc0 $pkgname-gdbm pyc-3.11:_pyc_meta:noarch
            url: https://www.python.org/
            version: 3.11.14
        - uses: abuild/build@v1
          work-dir: ${source.dir}/aports/python-3.11
        - uses: abuild/upload@v1
os-release:
  name: Docker Hardened Images (Alpine)
  id: alpine
  version-id: "3.23"
  pretty-name: Docker Hardened Images/Alpine Linux v3.23
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  SETUPTOOLS_VERSION: ""
